# üîç WebSocket Client - So S√°nh Tr·ª±c Quan

## üìç V·ªã Tr√≠ Trong Code

```
BattleShip/
‚îú‚îÄ‚îÄ client/scripts/websocket/
‚îÇ   ‚îî‚îÄ‚îÄ client.js          ‚Üê ‚úÖ JAVASCRIPT CLIENT (Production)
‚îî‚îÄ‚îÄ test/
    ‚îî‚îÄ‚îÄ Spec.hs            ‚Üê ‚ö†Ô∏è HASKELL CLIENT (Test only)
```

---

## üéØ 1. JavaScript WebSocket Client (Production)

### üìÇ File: `client/scripts/websocket/client.js`

```javascript
/**
 * ‚úÖ ƒê√ÇY L√Ä CLIENT TH·∫¨T - CH·∫†Y TRONG BROWSER
 * User ch∆°i game ‚Üí D√πng client n√†y
 */

class WebSocketManager {
    constructor() {
        this.ws = null;              // ‚Üê WebSocket instance
        this.roomId = null;
        this.playerId = null;
        this.messageHandlers = {};
    }

    // K·∫æT N·ªêI WEBSOCKET
    connect(roomId, playerId) {
        return new Promise((resolve, reject) => {
            // ‚òÖ T·∫†O WEBSOCKET CONNECTION
            const wsUrl = `ws://localhost:9160?roomId=${roomId}&playerId=${playerId}`;
            this.ws = new WebSocket(wsUrl);  // ‚Üê Browser WebSocket API
            
            // ‚òÖ X·ª¨ L√ù EVENTS
            this.ws.onopen = () => {
                console.log('‚úì WebSocket connected');
                resolve(true);
            };
            
            this.ws.onmessage = (event) => {
                this.handleMessage(event.data);  // ‚Üê Nh·∫≠n message t·ª´ server
            };
            
            this.ws.onclose = (event) => {
                console.log('WebSocket closed');
                this.handleDisconnect();
            };
            
            this.ws.onerror = (error) => {
                console.error('‚ùå WebSocket error:', error);
                reject(error);
            };
        });
    }
    
    // G·ª¨I MESSAGE
    send(message) {
        if (this.isConnected()) {
            this.ws.send(message);  // ‚Üê G·ª≠i ƒë·∫øn server
        }
    }
    
    // ƒêƒÇNG K√ù HANDLER
    on(messageType, callback) {
        this.messageHandlers[messageType] = callback;
    }
}

// ‚òÖ SINGLETON INSTANCE
const WSManager = new WebSocketManager();

// ‚òÖ EXPORT RA NGO√ÄI
if (typeof module !== 'undefined' && module.exports) {
    module.exports = WSManager;
}
```

### üéÆ C√°ch S·ª≠ D·ª•ng (Game Pages)

```javascript
// File: client/pages/1v1/room.html ho·∫∑c game.html

// 1. Import
import WSManager from '/scripts/websocket/client.js';

// 2. Connect khi v√†o room
await WSManager.connect(roomId, playerId);

// 3. ƒêƒÉng k√Ω handlers
WSManager.on('attack_result', (msg) => {
    console.log('K·∫øt qu·∫£ t·∫•n c√¥ng:', msg);
    updateBoard(msg);
});

WSManager.on('game_over', (msg) => {
    console.log('Game k·∫øt th√∫c, winner:', msg.gomWinner);
    showGameOverModal(msg);
});

// 4. G·ª≠i ready
const readyMsg = Protocol.buildReadyMessage(playerId, fleet);
WSManager.send(readyMsg);

// 5. G·ª≠i attack
const attackMsg = Protocol.buildAttackMessage(playerId, position);
WSManager.send(attackMsg);
```

---

## üß™ 2. Haskell WebSocket Client (Test Only)

### üìÇ File: `test/Spec.hs`

```haskell
{- 
 ‚ö†Ô∏è ƒê√ÇY L√Ä TEST CLIENT - CH·ªà D√ôNG TRONG TEST SUITE
 Automated testing ‚Üí D√πng client n√†y
-}

import qualified Network.WebSockets as WS

-- ============================================================================
-- Helper Functions
-- ============================================================================

-- | Start test WebSocket server
startTestServer :: IO WebSocketState
startTestServer = do
    roomMgr <- RoomMgr.newRoomManager
    playerMgr <- PlayerMgr.newPlayerManager
    wsConnections <- newTVarIO Map.empty
    
    let state = WebSocketState
            { wsRoomManager = roomMgr
            , wsPlayerManager = playerMgr
            , wsConnections = wsConnections
            }
    
    -- ‚òÖ START SERVER IN BACKGROUND
    _ <- forkIO $ WSServer.startWebSocketServer state
    threadDelay 500000  -- Wait 0.5s for server to start
    
    return state

-- | Connect WebSocket client (TEST CLIENT)
-- ‚òÖ‚òÖ‚òÖ ƒê√ÇY L√Ä PH·∫¶N B·ªä L·ªñI ‚òÖ‚òÖ‚òÖ
connectClient :: String -> String -> IO WS.Connection
connectClient roomId playerId = do
    let url = wsUrl roomId playerId
    -- ‚òÖ K·∫æT N·ªêI B·∫∞NG HASKELL WEBSOCKET LIBRARY
    WS.runClient testHost testPort 
        ("/?roomId=" ++ roomId ++ "&playerId=" ++ playerId) 
        return
    -- ‚ùå Connection failed ‚Üí Test failed

-- ============================================================================
-- Main Test Suite
-- ============================================================================

main :: IO ()
main = hspec $ do
    describe "WebSocket Server Tests" $ do
        
        describe "Connection Management" $ do
            it "should accept valid WebSocket connection" $ do
                state <- startTestServer  -- Start server
                
                result <- (do
                    -- ‚òÖ T·∫†O TEST CONNECTION
                    conn <- connectClient "ROOM01" "PLAY01"  -- ‚Üê L·ªói ·ªü ƒë√¢y!
                    
                    WS.sendClose conn ("Test done" :: T.Text)
                    return True
                    ) `catch` (\(_ :: SomeException) -> return False)
                
                result `shouldBe` True
                -- Expected: True
                -- But got: False  ‚Üê ‚ùå Test failed
```

### üß™ C√°ch S·ª≠ D·ª•ng (Test Suite)

```bash
# Ch·∫°y test
stack test

# Test s·∫Ω:
# 1. Start WebSocket server (Haskell)
# 2. Create test client (Haskell WS.runClient)
# 3. Try to connect
# 4. ‚ùå Connection failed ‚Üí Test failed
```

---

## üîÑ Side-by-Side Comparison

| Aspect | JavaScript Client | Haskell Test Client |
|--------|------------------|---------------------|
| **File** | `client/scripts/websocket/client.js` | `test/Spec.hs` |
| **Line** | Lines 1-204 | Lines 73-79 |
| **Purpose** | Production game client | Automated testing |
| **Who uses** | Players (humans) | CI/CD (machines) |
| **Runtime** | Browser (Chrome/Firefox) | Test suite (GHC) |
| **API** | `new WebSocket(url)` | `WS.runClient host port path` |
| **Status** | ‚úÖ **WORKS FINE** | ‚ùå **FAILING** |
| **Impact** | User plays game normally | Tests fail in CI/CD |

---

## üéØ Visual Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              WEBSOCKET CLIENT COMPARISON                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

PRODUCTION (JavaScript Client):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Browser (User opens game page)                           ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  1. Load: client/scripts/websocket/client.js             ‚îÇ
‚îÇ  2. User clicks "Join Room"                              ‚îÇ
‚îÇ  3. Call: WSManager.connect(roomId, playerId)            ‚îÇ
‚îÇ  4. Create: new WebSocket('ws://localhost:9160?...')     ‚îÇ
‚îÇ  5. Server accepts connection                            ‚îÇ
‚îÇ  6. ‚úÖ SUCCESS - User can play                           ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  Status: ‚úÖ WORKING                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

TEST (Haskell Client):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Test Suite (stack test command)                          ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  1. Load: test/Spec.hs                                   ‚îÇ
‚îÇ  2. Test runs: "should accept connection"                ‚îÇ
‚îÇ  3. Call: startTestServer (background thread)            ‚îÇ
‚îÇ  4. Call: connectClient "ROOM01" "PLAY01"                ‚îÇ
‚îÇ  5. Try: WS.runClient testHost testPort path             ‚îÇ
‚îÇ  6. ‚ùå FAILED - Connection refused/timeout               ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  Status: ‚ùå FAILING (8 out of 12 tests failed)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üêõ Debug Information

### ‚ùå Test Failures (8 failed)

```
Failures:

  1) WebSocket Server Tests, Connection Management, 
     should accept valid WebSocket connection
       expected: True
        but got: False
     
     ‚Üë This means: connectClient() in test/Spec.hs failed to connect
```

### ‚úÖ JavaScript Client (Still Working)

```javascript
// Users can still play game normally!
// client.js connects successfully to ws://localhost:9160
// No impact on production
```

---

## üìù K·∫øt Lu·∫≠n

### WebSocket Client L√† G√¨?

**2 ph·∫ßn ri√™ng bi·ªát:**

1. **`client/scripts/websocket/client.js`** 
   - ‚úÖ Production WebSocket client
   - Ch·∫°y trong browser
   - Users d√πng ƒë·ªÉ ch∆°i game
   - **KH√îNG C√ì V·∫§N ƒê·ªÄ**

2. **`test/Spec.hs` (connectClient function)**
   - ‚ö†Ô∏è Test WebSocket client
   - Ch·∫°y trong test suite
   - CI/CD d√πng ƒë·ªÉ test server
   - **ƒê√ÇY L√Ä PH·∫¶N B·ªä L·ªñI**

### V·∫•n ƒê·ªÅ N·∫±m ·ªû ƒê√¢u?

**Test client (Haskell) kh√¥ng connect ƒë∆∞·ª£c:**

```haskell
-- test/Spec.hs line 73-79
connectClient :: String -> String -> IO WS.Connection
connectClient roomId playerId = do
    let url = wsUrl roomId playerId
    WS.runClient testHost testPort      -- ‚Üê ‚ùå Failed here
        ("/?roomId=" ++ roomId ++ "&playerId=" ++ playerId) 
        return
```

**C√≥ th·ªÉ do:**
- Timing issue (server ch∆∞a ready)
- Path format kh√¥ng ƒë√∫ng
- Port conflict
- WebSocket handshake failed

### ‚úÖ Production Client V·∫´n OK

```javascript
// client/scripts/websocket/client.js
this.ws = new WebSocket(wsUrl);  // ‚Üê ‚úÖ Still works!
```

**User v·∫´n ch∆°i game b√¨nh th∆∞·ªùng!**
